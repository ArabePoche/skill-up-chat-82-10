-- Supprimer les anciennes politiques
DROP POLICY IF EXISTS "Admins can manage custom role permissions" ON public.school_role_permissions;
DROP POLICY IF EXISTS "Admins can update custom role permissions" ON public.school_role_permissions;
DROP POLICY IF EXISTS "Admins can delete custom role permissions" ON public.school_role_permissions;

-- Nouvelle politique INSERT: propriétaires peuvent ajouter des permissions pour n'importe quel rôle dans leur école
CREATE POLICY "School owners can insert role permissions" 
ON public.school_role_permissions 
FOR INSERT 
TO authenticated
WITH CHECK (
  school_id IS NOT NULL 
  AND is_school_admin_or_owner(auth.uid(), school_id)
);

-- Nouvelle politique UPDATE: propriétaires peuvent modifier les permissions dans leur école
CREATE POLICY "School owners can update role permissions" 
ON public.school_role_permissions 
FOR UPDATE 
TO authenticated
USING (
  school_id IS NOT NULL 
  AND is_school_admin_or_owner(auth.uid(), school_id)
);

-- Nouvelle politique DELETE: propriétaires peuvent supprimer les permissions dans leur école
CREATE POLICY "School owners can delete role permissions" 
ON public.school_role_permissions 
FOR DELETE 
TO authenticated
USING (
  school_id IS NOT NULL 
  AND is_school_admin_or_owner(auth.uid(), school_id)
);